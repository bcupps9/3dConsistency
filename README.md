# 3dConsistency
Work here builds on persistent memory models used in diffusion based video generation to enforce scene consistency

## Local vs Remote Workflow (Wan2.2)

Local setup (no inference, no flash_attn):
1. Create venv: `/opt/homebrew/bin/python3.12 -m venv .venv`
2. Activate: `source .venv/bin/activate`
3. Upgrade tools: `python -m pip install -U pip setuptools wheel`
4. Install local deps: `python -m pip install -r requirements/local.txt`
5. Init submodule: `git submodule update --init --recursive`

Sync to cluster:
1. `bash scripts/sync_to_remote.sh`

Remote one-time setup (on cluster):
1. `ssh user@login.rc.fas.harvard.edu`
2. `cd ~/projects/3dConsistency`
3. `python -m venv .venv`Like today. But it makes me warmer. I don't have to worry about getting a half percent. Princeton like. Your College in Princeton like. Will give you like a straight up like, it's kind of nice. It's kind of nice. And I am jealous. I'm so jealous of all the Princetonians, just actually so. Happy to see you too. Did you have a good dinner? It was good. It was good. Sorry. I had dinner. And then I worked for a chunk of time, and then I, as I was exiting Quincy, I ran into a friend that I had seen in a while. You did scare me. Like, significantly, I was sorry. Sorry. Yeah, I was. I'd run. And then. I cannot handle my package dependencies properly, so I just like banging on my computer and then. And then I said, Oh my, gosh, let me shower and yeah. No, no worries. It made me, it made me do that all very fast. No, no wasted time. Yeah, we got tear back from the Super Bowl room. And then wait, what's this? That's my mom. I should use it instead of the one that I could use for, yeah. Oh, soccer. My mom made one of them for each of the seniors on the team that is adorable 0. So she she like so she didn't she didn't make it, but like I didn't know if you might like she printed it out and then like hemmed it or something that would be. Only my grandma. My mother. So many ideas and so many good ways of outsourcing, but not. Getting her hands on it. Yeah, exactly. Exactly. When they should also want to update the room says is there. Now. Glad to hear. And they all have you got wine in exchange. Thank you. Yeah. Although I guess it might not be a fairview for you if you're not drinking the wine. Yes you are and my other roommates drink the wine, but you could wine collection it. Yes, yes, yes, yes, the. The mini fridge on the other side of the house. Two bottles. Yeah, I mean, there's like a drink, but just our fridge is over there. So it's not like you have two visions. It's one good community shared, yes. Oh, actually Joe I think has a fridge in his room, but that was not coming. Just reach out, yeah. But he brings he's the best contributor to the global food supply. It's because he would go back home. Yes, he goes back home. I don't like what way more than me I'll come back once a week. I go back mandatory once a week and then last. Like until this semester. I went back like two, like two days like I would have to sleep. No time. 's in class and it was so. Yes 0 you keep your window open sometimes only because. I went to this friend's birthday party yesterday. Or like surprise party and. And their rooms not so bad. And I was like, Oh my, gosh, I'm. I'm now forever scared that my room is gonna start. I don't think you ever smells back. Yeah, but. This is our time. For the. This one? Yeah, I think this one. I didn't either, but then they will be helpful, right. I realized, yeah. And it's like all the material is kind of right there and you just get to flip through. This is a senior year revelation, I know that much, but a little bit it's kind of like. When it was Margo, right. Margo, yeah, the girl, the girlfriend sitting behind you teaching us about the final over the non final. Yeah. I didn't know that it was not a final. I think, she said. I haven't opened either this one or this one, but I opened this one today. Is this also ruined some different? Yeah, why did I swear this is the first time I've ever done like multiple of the class textbooks? In the past either. You download the PDF. Yeah, but having a physical book I understand is nice. I love. I don't know about you, but like reading a PDF versus reading it's so much paper. Except imagine if there was a way to come in on paper and then that would be cool. That would be so nice. Cool. That would be amazing. I guess, alas, yeah. Yeah, you're talking for like a textbook when you all the yeah. I was thinking about. More stories. And then it's just like kind of there and it only happens once. So you just find the the occurrence of the advantage, but yes. Were you sitting in Lynn's room? No, I was. She she had to come to Mather for, like, a piece at night or something. Oh, yeah. We always have peace at night. So she actually came here, so she left me in like a little like a little room. I had to lock in though. No, no. I mean when I don't have to lock it in the, I don't know. Anyone of our rooms down there. Oh, you can more successfully lock it. On the bridge across that you see when you walk into the dining room, there's. There's a music room there, and then a study room makes it, and then over there somewhere, it's like tranquility, room tranquility. The meditation, yeah, what career happened to. But it's miniscule. Absolutely. Like a little, petite little. Box, yeah. Yeah, and like a. Oh, and an art studio is the cardio. Just like treadmill after treadmill. It's like it's tiny. It's just probably one treadmill and one buttock. That's pretty cool. It's separate from the gym, which is. OK and then our other fun rooms are the wood turning studio and the ceramic studio. Studio. I think you like you would make a wood bowl by starting a piece of wood and there's something. That's strangers machinery like. Settings it off probably. I know more people that do ceramic studio than the wood. Yeah, what would you say? Why they call it with turning? I think because the rotational part is like this into but. But ceramics they don't call turning at all, so. Yeah. My sister would go to that every. As you read last Wednesday, and I think she was intending to make a bowl or something for somebody for Christmas. I don't think it like came out. She just failed every week. So it's like you can be like any houses resident to use the ceramics to yes and you like they just have clay. I think you have to sign up for the class but. Yes, if you as a career person that had some ceramic desire, yes, then you could totally come down and and make this is very, very nice guy who teaches stuff. That's pretty cool the class, so I want to try. If ceramics is on it, it's not pious, OK, OK. What would be the highest? To play to win. I am soccer championship with mother. This is, this is **** OK. When does that happen? Do you like, I think in a couple weeks? And then Jonas had been chair for I could sit anywhere, yeah. I'm afraid I do have outside clothes, except actually I'm wearing leggings underneath because I woke up this morning and I checked the weather and I was like. So I could always just take off my jeans and I'll be in inside clothes, inside clothes. Exactly. That would be cool. That could be very cool. Yeah. If it needs to be hotter, I can also. I think I'm fine, but just OK it is where we are. Is that your play every time that it's below. 20. Only as of this year, I think OK getting old. Sorry, my friend has just texted me like this many texts. I don't know what to do with her. Her name is Michelle Mitchie. She is sweet mates with Stella and. I met her through Stella. And Ohio? She's in 262. But I look he don't think she pulls off the class. So you might not see her, actually. We're getting less and less participation there, really. And he's a little bit desperate 0. Oh no. Yeah. Inside, clothes are on. I sacked fest myself a couple times today. In terms of in terms of, just like you need an answer and you sure I'll give you an answer. Well, this girl sent me 26 tech. Oh my God where are my slides? Because there might be water on the floor. OK. Whoa. Vivid. With conferences, tech offices. How are you still waiting for resources? 
4. `source .venv/bin/activate`
5. `python -m pip install -U pip setuptools wheel`
6. `python -m pip install -r requirements/remote.txt`
7. Install a CUDA-compatible torch build per your cluster guidance.
8. Store temp data at temporary scratch storage found at /n/netscratch. This is a VAST file system with 4 PB of storage and connected via Infiniband fabric. This temporary scratch space is available from all compute nodes.
9. Do not run inference on login nodes; submit jobs via Slurm.
10. Send inference data back to scratch space

Submit inference job:
1. Find partitions you can use: `spart`
2. `GPU_PARTITION=<your_gpu_partition> bash scripts/submit_slurm.sh`
3. Optional custom run id: `bash scripts/submit_slurm.sh my_run_id`

Fetch outputs:
1. `bash scripts/fetch_run.sh <run_id>`

General Job Submission tips:

Likely using sbatch ____ to run a script which then allows the compute node access to run what it needs and informatiion about what to write back. 


#!/bin/bash
#SBATCH -c 1                # Number of cores (-c)
#SBATCH -t 0-00:10          # Runtime in D-HH:MM, minimum of 10 minutes
#SBATCH -p serial_requeue   # Partition to submit to
#SBATCH --mem=100           # Memory pool for all cores (see also --mem-per-cpu)
#SBATCH -o myoutput_%j.out  # File to which STDOUT will be written, %j inserts jobid
#SBATCH -e myerrors_%j.err  # File to which STDERR will be written, %j inserts jobid

# load modules
module load python/3.10.9-fasrc01

# run code
python -c 'print("Hi there.")'

In general, the script is composed of 4 parts.

the #!/bin/bash line allows the script to be run as a bash script
the #SBATCH lines are technically bash comments, but they set various parameters for the SLURM scheduler
loading any necessary modules and setting any variables, paths, etc.
the command line itself, in this case calling python and having it print a message.


i think though we are close in terms of having the right package there and havingth right python

Upon login:
module load Miniforge3/24.11.3-fasrc02
eval "$(/n/sw/Miniforge3-24.11.3-0-fasrc02/bin/conda shell.bash hook)"
conda activate ~/projects/3dConsistency/.mamba/wan2

which python

Then, cuda checks for flash_attn:
module load cuda/12.4.1-fasrc01
which nvcc
nvcc --version

needed for flash_attn:
python -m pip install -U psutil

potential test run:
python generate.py \
  --task ti2v-5B \
  --size '1280*704' \
  --ckpt_dir /n/netscratch/ydu_lab/Lab/bcupps/models/Wan2.2-TI2V-5B \
  --offload_model True \
  --convert_model_dtype \
  --t5_cpu \
  --prompt "Two anthropomorphic cats in comfy boxing gear and bright gloves fight intensely on a spotlighted stage." \
  --save_file /n/netscratch/ydu_lab/Lab/bcupps/results/ti2v_5b_test.mp4